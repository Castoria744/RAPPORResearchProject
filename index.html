<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RAPPOR Customer Logger</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Space+Grotesk:wght@300;500;700&display=swap');

  :root {
    --bg: #000000;
    --surface: #111318;
    --border: #1e2330;
    --accent: #00e5a0;
    --accent2: #0090ff;
    --danger: #ff4466;
    --warn: #ffaa00;
    --text: #c8d0e0;
    --muted: #4a5568;
    --label: #7a8ba0;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Space Grotesk', sans-serif;
    min-height: 100vh;
    padding: 40px 20px;
    background-image: radial-gradient(ellipse at 20% 0%, rgba(0,229,160,0.05) 0%, transparent 50%),
                      radial-gradient(ellipse at 80% 100%, rgba(0,144,255,0.05) 0%, transparent 50%);
  }

  .container { max-width: 860px; margin: 0 auto; }

  header {
    margin-bottom: 36px;
    border-left: 3px solid var(--accent);
    padding-left: 16px;
  }
  header h1 { font-size: 1.6rem; font-weight: 700; letter-spacing: -0.5px; color: #fff; }
  header p  { font-size: 0.82rem; color: var(--label); margin-top: 4px; font-family: 'IBM Plex Mono', monospace; }

  .badge {
    display: inline-block;
    background: rgba(0,229,160,0.1);
    border: 1px solid rgba(0,229,160,0.3);
    color: var(--accent);
    font-size: 0.7rem;
    font-family: 'IBM Plex Mono', monospace;
    padding: 2px 8px;
    border-radius: 4px;
    margin-top: 8px;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 28px;
    margin-bottom: 24px;
  }
  .card h2 {
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--label);
    margin-bottom: 20px;
  }

  .form-row   { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
  .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px; }
  .form-row-1 { display: grid; grid-template-columns: 1fr; gap: 16px; margin-bottom: 16px; }

  .field label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--label);
    margin-bottom: 7px;
    font-family: 'IBM Plex Mono', monospace;
  }

  .field input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 11px 13px;
    color: #fff;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.88rem;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .field input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(0,229,160,0.08);
  }
  .field input.error {
    border-color: var(--danger);
    box-shadow: 0 0 0 3px rgba(255,68,102,0.1);
  }
  .field .hint {
    font-size: 0.65rem;
    color: var(--muted);
    font-family: 'IBM Plex Mono', monospace;
    margin-top: 5px;
  }
  .field .hint.err { color: var(--danger); }

  .params-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
    margin-bottom: 20px;
  }
  .param-item {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
  }
  .param-item label {
    display: block;
    font-size: 0.63rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--muted);
    margin-bottom: 6px;
    font-family: 'IBM Plex Mono', monospace;
  }
  .param-item input[type="range"] { width: 100%; accent-color: var(--accent); }
  .param-item .val { font-family: 'IBM Plex Mono', monospace; font-size: 0.85rem; color: var(--accent); margin-top: 4px; }

  .btn-row { display: flex; gap: 10px; align-items: center; margin-top: 20px; }

  button {
    background: var(--accent);
    color: #000;
    border: none;
    border-radius: 8px;
    padding: 12px 28px;
    font-family: 'Space Grotesk', sans-serif;
    font-weight: 700;
    font-size: 0.9rem;
    cursor: pointer;
    letter-spacing: 0.5px;
    transition: opacity 0.2s, transform 0.1s;
  }
  button:hover  { opacity: 0.88; }
  button:active { transform: scale(0.98); }

  .btn-secondary {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--label);
  }

  .toggle-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
    font-size: 0.8rem;
    color: var(--label);
  }
  .toggle { position: relative; width: 36px; height: 20px; cursor: pointer; }
  .toggle input { display: none; }
  .toggle-track {
    position: absolute; inset: 0;
    background: var(--border); border-radius: 10px; transition: background 0.2s;
  }
  .toggle input:checked + .toggle-track { background: var(--accent); }
  .toggle-thumb {
    position: absolute; top: 3px; left: 3px;
    width: 14px; height: 14px;
    background: #fff; border-radius: 50%; transition: left 0.2s;
  }
  .toggle input:checked ~ .toggle-thumb { left: 19px; }

  .info-box {
    background: rgba(0,144,255,0.07);
    border: 1px solid rgba(0,144,255,0.2);
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 0.78rem;
    color: var(--label);
    line-height: 1.6;
    margin-bottom: 20px;
  }
  .info-box strong { color: var(--accent2); }

  /* Log */
  .log-area { max-height: 480px; overflow-y: auto; }

  .log-entry {
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 14px 14px 18px;
    margin-bottom: 12px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.76rem;
    animation: slideIn 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  .log-entry::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    background: var(--accent);
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .log-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    flex-wrap: wrap;
    gap: 4px;
  }
  .log-id   { color: var(--accent2); font-weight: 600; }
  .log-time { color: var(--muted); font-size: 0.7rem; }
  .log-eps  { color: var(--warn); font-size: 0.7rem; }

  .log-fields { display: grid; gap: 5px; }
  .log-field  { display: flex; gap: 8px; align-items: baseline; }
  .log-field-label { color: var(--label); min-width: 90px; flex-shrink: 0; }
  .log-field-raw   { color: var(--muted); text-decoration: line-through; margin-right: 4px; }
  .log-field-enc   { color: var(--accent); word-break: break-all; }

  .empty-state {
    text-align: center;
    padding: 40px;
    color: var(--muted);
    font-size: 0.85rem;
  }

  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
</style>
</head>
<body>
<div class="container">

  <header>
    <h1>Customer Logger</h1>
    <p>Privacy-preserving data collection system</p>
    <span class="badge">üîê RAPPOR Enabled</span>
  </header>

  <div class="info-box">
    <strong>RAPPOR</strong> (Randomized Aggregatable Privacy-Preserving Ordinal Response) applies
    <strong>local differential privacy</strong> to every field. Each value is encoded into a Bloom filter,
    then bits are randomly flipped based on parameters <strong>f</strong> (permanent noise),
    <strong>p</strong>, and <strong>q</strong> (instantaneous noise). Raw data is never stored.
  </div>

  <!-- Input Form -->
  <div class="card">
    <h2>New Customer Entry</h2>

    <!-- Row 1: Names -->
    <div class="form-row">
      <div class="field">
        <label>First Name</label>
        <input type="text" id="firstName" placeholder="e.g. Jane" autocomplete="off" />
      </div>
      <div class="field">
        <label>Last Name</label>
        <input type="text" id="lastName" placeholder="e.g. Smith" autocomplete="off" />
      </div>
    </div>

    <!-- Row 2: Email + DOB -->
    <div class="form-row">
      <div class="field">
        <label>Email Address</label>
        <input type="text" id="email" placeholder="e.g. jane@example.com" autocomplete="off" />
        <div class="hint" id="emailHint"></div>
      </div>
      <div class="field">
        <label>Date of Birth</label>
        <input type="text" id="dob" placeholder="YYYY-MM-DD" autocomplete="off" maxlength="10" />
        <div class="hint" id="dobHint">Format: YYYY-MM-DD</div>
      </div>
    </div>

    <!-- Row 3: Address -->
    <div class="form-row-1">
      <div class="field">
        <label>Street Address</label>
        <input type="text" id="address" placeholder="e.g. 123 Queen Street, Auckland" autocomplete="off" />
      </div>
    </div>

    <!-- RAPPOR Params -->
    <div class="params-row">
      <div class="param-item">
        <label>f ‚Äî Permanent Noise</label>
        <input type="range" id="paramF" min="0" max="1" step="0.05" value="0.5" oninput="updateParams()" />
        <div class="val" id="fVal">0.50</div>
      </div>
      <div class="param-item">
        <label>p ‚Äî False Positive Rate</label>
        <input type="range" id="paramP" min="0" max="1" step="0.05" value="0.75" oninput="updateParams()" />
        <div class="val" id="pVal">0.75</div>
      </div>
      <div class="param-item">
        <label>q ‚Äî True Positive Rate</label>
        <input type="range" id="paramQ" min="0" max="1" step="0.05" value="0.5" oninput="updateParams()" />
        <div class="val" id="qVal">0.50</div>
      </div>
    </div>

    <div class="toggle-row">
      <label class="toggle">
        <input type="checkbox" id="showRaw" />
        <div class="toggle-track"></div>
        <div class="toggle-thumb"></div>
      </label>
      <span>Show original values (crossed out) for demonstration</span>
    </div>

    <div class="btn-row">
      <button onclick="logEntry()">Log Customer</button>
      <button class="btn-secondary" onclick="clearLog()">Clear Log</button>
    </div>
  </div>

  <!-- Log Output -->
  <div class="card">
    <h2>
      Logged Entries
      <span id="countBadge" style="color:var(--accent);font-family:'IBM Plex Mono',monospace;font-size:0.85rem;text-transform:none;letter-spacing:0;">(0)</span>
    </h2>
    <div class="log-area" id="logArea">
      <div class="empty-state" id="emptyState">No entries yet. Log a customer above.</div>
    </div>
  </div>

</div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// RAPPOR Core
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const BLOOM_SIZE = 128;
const NUM_HASHES = 2;

function hash(str, seed) {
  let h = seed;
  for (let i = 0; i < str.length; i++) {
    h = Math.imul(h ^ str.charCodeAt(i), 0x9e3779b9);
    h ^= h >>> 16;
  }
  return Math.abs(h);
}

function bloomEncode(value) {
  const bits = new Uint8Array(BLOOM_SIZE);
  for (let i = 0; i < NUM_HASHES; i++) {
    const h = hash(value.toLowerCase(), i * 0x5f3759df);
    bits[h % BLOOM_SIZE] = 1;
    for (let j = 0; j < value.length; j++) {
      const ch = hash(value[j].toLowerCase(), i * 0x9e3779b9 + j);
      bits[ch % BLOOM_SIZE] = 1;
    }
  }
  return bits;
}

function permanentRR(bloomBits, f) {
  const prr = new Uint8Array(BLOOM_SIZE);
  for (let i = 0; i < BLOOM_SIZE; i++) {
    const r = Math.random();
    if      (r < f / 2) prr[i] = 1;
    else if (r < f)     prr[i] = 0;
    else                prr[i] = bloomBits[i];
  }
  return prr;
}

function instantaneousRR(prrBits, p, q) {
  const irr = new Uint8Array(BLOOM_SIZE);
  for (let i = 0; i < BLOOM_SIZE; i++) {
    const r = Math.random();
    irr[i] = prrBits[i] === 1 ? (r < q ? 1 : 0) : (r < p ? 1 : 0);
  }
  return irr;
}

function rappor(value, f, p, q) {
  const bloom = bloomEncode(value);
  const prr   = permanentRR(bloom, f);
  const irr   = instantaneousRR(prr, p, q);
  return bitsToHex(irr);
}

function bitsToHex(bits) {
  let hex = '';
  for (let i = 0; i < bits.length; i += 8) {
    let byte = 0;
    for (let j = 0; j < 8 && (i + j) < bits.length; j++)
      byte |= (bits[i + j] << (7 - j));
    hex += byte.toString(16).padStart(2, '0').toUpperCase();
  }
  return hex;
}

function estimateEpsilon(f, p, q) {
  const pS = (1 - f/2) * p + (f/2) * (1 - q);
  const qS = (1 - f/2) * q + (f/2) * (1 - p);
  if (qS <= pS || pS <= 0 || qS >= 1) return '‚àû';
  return (2 * Math.log(qS * (1 - pS) / (pS * (1 - qS)))).toFixed(3);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Validation
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function validateEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

function validateDob(dob) {
  if (!/^\d{4}-\d{2}-\d{2}$/.test(dob)) return false;
  const d = new Date(dob);
  if (isNaN(d.getTime())) return false;
  const yr = d.getFullYear();
  return yr >= 1900 && yr <= new Date().getFullYear();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// UI
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let entries = [];
let idCounter = 1;

function updateParams() {
  document.getElementById('fVal').textContent = parseFloat(document.getElementById('paramF').value).toFixed(2);
  document.getElementById('pVal').textContent = parseFloat(document.getElementById('paramP').value).toFixed(2);
  document.getElementById('qVal').textContent = parseFloat(document.getElementById('paramQ').value).toFixed(2);
}

function setError(inputId, hintId, msg) {
  const input = document.getElementById(inputId);
  input.classList.add('error');
  if (hintId) {
    const hint = document.getElementById(hintId);
    hint.textContent = msg;
    hint.classList.add('err');
  }
}

function clearErrors() {
  ['firstName','lastName','email','dob','address'].forEach(id => {
    document.getElementById(id).classList.remove('error');
  });
  ['emailHint','dobHint'].forEach(id => {
    const el = document.getElementById(id);
    el.classList.remove('err');
  });
  document.getElementById('dobHint').textContent = 'Format: YYYY-MM-DD';
  document.getElementById('emailHint').textContent = '';
}

function logEntry() {
  clearErrors();

  const first   = document.getElementById('firstName').value.trim();
  const last    = document.getElementById('lastName').value.trim();
  const email   = document.getElementById('email').value.trim();
  const dob     = document.getElementById('dob').value.trim();
  const address = document.getElementById('address').value.trim();
  const showRaw = document.getElementById('showRaw').checked;

  let valid = true;

  if (!first)                { setError('firstName', null, ''); valid = false; }
  if (!last)                 { setError('lastName',  null, ''); valid = false; }
  if (!validateEmail(email)) { setError('email', 'emailHint', 'Invalid ‚Äî use user@domain.com'); valid = false; }
  if (!validateDob(dob))     { setError('dob',   'dobHint',   'Invalid ‚Äî use YYYY-MM-DD'); valid = false; }
  if (!address)              { setError('address', null, ''); valid = false; }

  if (!valid) return;

  const f = parseFloat(document.getElementById('paramF').value);
  const p = parseFloat(document.getElementById('paramP').value);
  const q = parseFloat(document.getElementById('paramQ').value);

  const entry = {
    id: idCounter++,
    time: new Date().toLocaleTimeString(),
    showRaw,
    raw: { first, last, email, dob, address },
    encoded: {
      first:   rappor(first,   f, p, q),
      last:    rappor(last,    f, p, q),
      email:   rappor(email,   f, p, q),
      dob:     rappor(dob,     f, p, q),
      address: rappor(address, f, p, q),
    },
    params: { f, p, q, eps: estimateEpsilon(f, p, q) },
  };

  entries.unshift(entry);
  renderLog();

  // Clear inputs
  ['firstName','lastName','email','dob','address'].forEach(id => {
    document.getElementById(id).value = '';
  });
}

function field(label, raw, enc, showRaw) {
  return `
    <div class="log-field">
      <span class="log-field-label">${label}</span>
      ${showRaw ? `<span class="log-field-raw">${raw}</span>` : ''}
      <span class="log-field-enc">${enc}</span>
    </div>`;
}

function renderLog() {
  const area = document.getElementById('logArea');
  document.getElementById('countBadge').textContent = `(${entries.length})`;

  if (entries.length === 0) {
    area.innerHTML = '<div class="empty-state" id="emptyState">No entries yet. Log a customer above.</div>';
    return;
  }

  area.innerHTML = entries.map(e => `
    <div class="log-entry">
      <div class="log-meta">
        <span class="log-id">#${String(e.id).padStart(4,'0')}</span>
        <span class="log-time">${e.time}</span>
        <span class="log-eps">Œµ‚âà${e.params.eps} &nbsp;|&nbsp; f=${e.params.f} p=${e.params.p} q=${e.params.q}</span>
      </div>
      <div class="log-fields">
        ${field('FIRST_NAME:',  e.raw.first,   e.encoded.first,   e.showRaw)}
        ${field('LAST_NAME:',   e.raw.last,    e.encoded.last,    e.showRaw)}
        ${field('EMAIL:',       e.raw.email,   e.encoded.email,   e.showRaw)}
        ${field('DOB:',         e.raw.dob,     e.encoded.dob,     e.showRaw)}
        ${field('ADDRESS:',     e.raw.address, e.encoded.address, e.showRaw)}
      </div>
    </div>
  `).join('');
}

function clearLog() {
  entries = [];
  idCounter = 1;
  renderLog();
}

updateParams();
</script>
</body>
</html>